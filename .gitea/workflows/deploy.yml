name: Deploy pihole6_exporter

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 1)  Check out repository
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Checkout code
      uses: actions/checkout@v4

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 2)  Stage the files we want to copy to the Pi
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Build deploy bundle
      run: |
        mkdir -p deploy_files
        cp pihole6_exporter.py deploy_files/
        cp pihole6_exporter.service   deploy_files/
        cp requirements.txt           deploy_files/
        cp pihole6_exporter.env       deploy_files/

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 3)  Secure-copy the bundle to the Raspberry Pi
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Copy files to Raspberry Pi
      uses: appleboy/scp-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        source:   "deploy_files"          # send the whole folder
        target:   "/tmp/pihole6_exporter"
        strip_components: 1               # drop the leading "deploy_files/" dir
        rm:       true                 # clean target dir before upload

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 4)  Ensure pip3 + venv prerequisites
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Ensure Python prerequisites
      uses: appleboy/ssh-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        script: |
          set -e
          echo "๐  Installing python3-pip / python3-venv if missingโฆ"
          sudo apt-get update -qq
          if ! command -v pip3 >/dev/null 2>&1; then
            sudo apt-get install -y python3-pip
          fi
          sudo apt-get install -y python3-venv

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 5)  Install the binary and systemd unit
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Install exporter binary and unit file
      uses: appleboy/ssh-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        script: |
          set -e
          echo "๐ Installing binary & systemd unitโฆ"
          sudo install -m 755 /tmp/pihole6_exporter/pihole6_exporter.py /usr/local/bin/pihole6_exporter
          sudo install -m 644 /tmp/pihole6_exporter/pihole6_exporter.service /etc/systemd/system/

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 6)  Create / refresh virtual-env and install Python deps
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Create/update virtual environment
      uses: appleboy/ssh-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        script: |
          set -e
          echo "๐ Setting up virtual environmentโฆ"
          sudo install -d /opt/pihole6_exporter
          sudo python3 -m venv /opt/pihole6_exporter/venv
          sudo /opt/pihole6_exporter/venv/bin/python -m pip install --upgrade pip
          sudo /opt/pihole6_exporter/venv/bin/pip install --no-cache-dir -r /tmp/pihole6_exporter/requirements.txt

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 7)  Install .env file
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Install .env file
      uses: appleboy/ssh-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        script: |
          set -e
          echo "๐ Installing .env fileโฆ"
          sudo install -d /etc/pihole6_exporter
          sudo install -m 600 /tmp/pihole6_exporter/pihole6_exporter.env /etc/pihole6_exporter/pihole6_exporter.env

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 8)  Reload systemd, enable & restart service, clean up tmp dir
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: Reload & restart service, clean up
      uses: appleboy/ssh-action@v1
      with:
        host:     ${{ secrets.PIHOLE_HOST }}
        username: ${{ secrets.PIHOLE_USER }}
        key:      ${{ secrets.PIHOLE_SSH_KEY }}
        script: |
          set -e
          echo "๐ Reloading systemd & restarting serviceโฆ"
          sudo systemctl daemon-reload
          sudo systemctl enable --now pihole6_exporter
          echo "๐งน Cleaning up /tmp filesโฆ"
          rm -rf /tmp/pihole6_exporter
          echo "โ Deployment completed successfully."
